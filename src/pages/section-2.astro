---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Hero from '../components/Hero.astro';
import PDFViewer from '../components/PDFViewer.astro';

// Images will be loaded client-side from S3 via API
// PDFs will be loaded and processed client-side
---

<BaseLayout title="Proces Bundel - Doel - Scharnierpunt">
  <Navigation />
  
  <!-- Hero Section -->
  <Hero 
    title="Process Bundle"
    subtitle="The full process of the design presented"
    height="large"
  />
  
  <!-- Content Section -->
  <section class="py-24 px-6 max-w-7xl mx-auto">
    <div class="mb-16" data-aos="fade-up">
      <h2 class="text-3xl md:text-4xl font-bold mb-4" data-i18n="sections.overview">Section Overview</h2>
      <p class="text-white/70 text-lg max-w-3xl" data-i18n="sections.section2Description">
        Welcome to Section 2 of our architecture portfolio. This section contains the complete process bundle showing our design development from concept to final presentation.
      </p>
    </div>
    
    <!-- PDF Documents Section -->
    <div id="pdf-section" class="mb-16">
      <h3 class="text-2xl font-bold mb-8 text-white" data-aos="fade-up" data-i18n="sections.processDocumentation">Process Documentation</h3>
      <div id="pdf-loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-amber-400"></div>
        <p class="mt-4 text-white/70" data-i18n="sections.loadingPdfDocuments">Loading PDF documents...</p>
      </div>
      <div id="pdf-container"></div>
    </div>
    

  </section>

  <script>
    import { getPreferredLanguage, t } from '../i18n/utils';
    
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing page...');
      initializePage();
    });
    
    function initializePage() {
      // Ensure page scrolling is enabled from the start
      document.body.style.overflow = 'auto';
      document.documentElement.style.overflow = 'auto';
      document.body.style.height = 'auto';
      document.documentElement.style.height = 'auto';
      
      // Update translations
      function updateTranslations() {
        console.log('Updating translations...');
        const currentLang = getPreferredLanguage();
        
        // Update all text with data-i18n
        document.querySelectorAll('[data-i18n]').forEach((el) => {
          const key = (el as HTMLElement).dataset.i18n;
          if (key) {
            const translation = t(key, currentLang);
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
              (el as HTMLInputElement).placeholder = translation;
            } else {
              el.textContent = translation;
            }
          }
        });
        
        // Update placeholders with data-i18n-placeholder
        document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
          const key = (el as HTMLElement).dataset.i18nPlaceholder;
          if (key) {
            (el as HTMLInputElement).placeholder = t(key, currentLang);
          }
        });
      }
    
    // Fetch and display PDFs
    async function loadPDFs() {
      console.log('Loading PDFs...');
      try {
        const response = await fetch('/api/pdf/2');
        const data = await response.json();
        console.log('PDF data received:', data);
        
        const pdfLoading = document.getElementById('pdf-loading');
        const pdfContainer = document.getElementById('pdf-container');
        
        if (pdfLoading) pdfLoading.classList.add('hidden');
        
        if (data.pdfs && data.pdfs.length > 0) {
          data.pdfs.forEach((pdf) => {
            console.log('Processing PDF:', pdf.filename);
            if (pdfContainer) {
              if (pdf.processed && pdf.pages && pdf.pages.length > 0) {
                // Create full PDF viewer with thumbnails
                const pdfElement = createFullPDFViewer(pdf);
                console.log('Created PDF element:', pdfElement);
                pdfContainer.appendChild(pdfElement);
              } else {
                // Create simple PDF download card
                const pdfElement = createSimplePDFCard(pdf);
                pdfContainer.appendChild(pdfElement);
              }
            }
          });
        } else {
          if (pdfContainer) {
            pdfContainer.innerHTML = `
              <div class="text-center py-12" data-aos="fade-up">
                <div class="mb-6">
                  <svg class="w-16 h-16 mx-auto text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <h4 class="text-xl font-bold mb-3">${t('sections.noPdfDocuments', getPreferredLanguage())}</h4>
                <p class="text-white/60 max-w-md mx-auto text-sm">
                  ${t('sections.noPdfDocumentsDescription', getPreferredLanguage())}
                </p>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error loading PDFs:', error);
        const pdfLoading = document.getElementById('pdf-loading');
        const pdfContainer = document.getElementById('pdf-container');
        if (pdfLoading) pdfLoading.classList.add('hidden');
        if (pdfContainer) {
          pdfContainer.innerHTML = `
            <div class="text-center py-12 text-red-400">
              <p>${t('sections.failedToLoadPdfs', getPreferredLanguage())}</p>
            </div>
          `;
        }
      }
    }
    
    // Create full PDF viewer element
    function createFullPDFViewer(pdf: any) {
      console.log('Creating PDF viewer for:', pdf.filename);
      
      const currentLang = getPreferredLanguage();
      
      const container = document.createElement('div');
      container.className = 'book-viewer-container';
      container.setAttribute('data-aos', 'fade-up');
      container.setAttribute('data-total-pages', pdf.totalPages.toString());
      container.setAttribute('data-pages', JSON.stringify(pdf.pages));
      
      console.log('Container created:', container);
      
      // Create header
      const header = document.createElement('div');
      header.className = 'bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-8';
      header.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h3 class="text-2xl font-bold text-white mb-2">${pdf.filename}</h3>
            <p class="text-white/70">${pdf.totalPages} ${t('sections.pages', currentLang)} ‚Ä¢ ${t('sections.processBundleDocumentation', currentLang)}</p>
          </div>
          <div class="flex gap-3">
            <button id="book-view-btn" class="px-4 py-2 bg-amber-500 text-black font-semibold rounded-lg hover:bg-amber-400 transition-colors">
              ${t('sections.bookView', currentLang)}
            </button>
            <button id="grid-view-btn" class="px-4 py-2 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 transition-colors">
              ${t('sections.gridView', currentLang)}
            </button>
            <a href="${pdf.url}" target="_blank" class="px-4 py-2 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 transition-colors">
              ${t('sections.downloadPdf', currentLang)}
            </a>
          </div>
        </div>
      `;
      
      // Create book view
      const bookView = document.createElement('div');
      bookView.id = 'book-view';
      bookView.className = 'book-container';
      
      // Book cover
      const bookCover = document.createElement('div');
      bookCover.className = 'book-cover mb-8';
      bookCover.setAttribute('data-aos', 'zoom-in');
      bookCover.innerHTML = `
        <div class="book-spine"></div>
        <div class="book-front">
          <div class="book-content">
            <div class="cover-image">
              <img src="${pdf.pages[0]?.thumbnailUrl}" alt="Cover" class="w-full h-full object-cover rounded-lg" />
            </div>
            <div class="cover-overlay">
              <h4 class="text-white text-xl font-bold mb-2">${pdf.filename}</h4>
              <p class="text-white/80 text-sm">${t('sections.architecturePortfolio', currentLang)}</p>
              <p class="text-white/60 text-xs mt-2">${pdf.totalPages} ${t('sections.pages', currentLang)}</p>
              <button id="open-book-btn" class="mt-4 px-6 py-2 bg-amber-500 text-black font-semibold rounded-lg hover:bg-amber-400 transition-colors">
                ${t('sections.openBook', currentLang)}
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Book reader
      const bookReader = document.createElement('div');
      bookReader.id = 'book-reader';
      bookReader.className = 'hidden';
      bookReader.innerHTML = `
        <div class="book-reader-container">
          <div class="book-page left-page">
            <div class="page-content">
              <img id="left-page-img" src="" alt="" class="page-image" />
              <div class="page-number left">
                <span id="left-page-number"></span>
              </div>
            </div>
          </div>
          <div class="book-binding"></div>
          <div class="book-page right-page">
            <div class="page-content">
              <img id="right-page-img" src="" alt="" class="page-image" />
              <div class="page-number right">
                <span id="right-page-number"></span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="book-controls">
          <button id="prev-page-btn" class="control-btn prev-btn">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span>${t('sections.previous', currentLang)}</span>
          </button>
          
          <div class="page-indicator">
            <span id="current-spread">1-2</span> / ${Math.ceil(pdf.totalPages / 2)}
          </div>
          
          <button id="next-page-btn" class="control-btn next-btn">
            <span>${t('sections.next', currentLang)}</span>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
        
        <div class="page-thumbnails">
          <div class="thumbnails-container">
            ${pdf.pages.map((page: any) => `
              <button class="thumbnail-btn" data-page="${page.pageNumber}" title="Page ${page.pageNumber}">
                <img src="${page.thumbnailUrl}" alt="Page ${page.pageNumber}" class="thumbnail-img" />
                <span class="thumbnail-number">${page.pageNumber}</span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
      
      bookView.appendChild(bookCover);
      bookView.appendChild(bookReader);
      
      // Create grid view
      const gridView = document.createElement('div');
      gridView.id = 'grid-view';
      gridView.className = 'hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8 relative';
      
      pdf.pages.forEach((page: any) => {
        const pageCard = document.createElement('div');
        pageCard.className = 'pdf-page-card bg-slate-800/30 border border-white/10 rounded-lg overflow-hidden hover:border-amber-400/50 transition-all duration-300 cursor-pointer';
        pageCard.setAttribute('data-page', page.pageNumber.toString());
        pageCard.setAttribute('data-full-image', page.imageUrl);
        pageCard.innerHTML = `
          <div class="aspect-[3/4] overflow-hidden">
            <img src="${page.thumbnailUrl}" alt="Page ${page.pageNumber}" 
                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" loading="lazy" />
          </div>
          <div class="p-3">
            <p class="text-white/80 text-sm font-medium">Page ${page.pageNumber}</p>
          </div>
        `;
        gridView.appendChild(pageCard);
      });
      
      // Assemble the container
      container.appendChild(header);
      container.appendChild(bookView);
      container.appendChild(gridView);
      
      // Add styles
      addBookViewerStyles();
      
      console.log('Final container:', container);
      return container;
    }
    
    function addBookViewerStyles() {
      if (!document.querySelector('#book-viewer-styles')) {
        const style = document.createElement('style');
        style.id = 'book-viewer-styles';
        style.textContent = `
          /* Ensure page can scroll */
          html, body { 
            overflow-x: hidden; 
            overflow-y: auto !important; 
            height: auto !important; 
            min-height: 100vh;
          }
          
          /* Ensure grid view doesn't interfere with scrolling */
          #grid-view {
            position: relative !important;
            overflow: visible !important;
            height: auto !important;
          }
          
          .book-container { 
            max-width: 100%; 
            margin: 0 auto; 
            perspective: 2000px; 
            padding: 0 20px; 
            position: relative !important;
            overflow: visible !important;
          }
          .book-cover { position: relative; width: 400px; height: 500px; margin: 0 auto; transform-style: preserve-3d; transition: transform 0.6s ease-in-out; cursor: pointer; }
          .book-spine { position: absolute; left: -25px; top: 0; width: 25px; height: 100%; background: linear-gradient(to right, #1e293b, #334155); border-radius: 4px 0 0 4px; transform: rotateY(-90deg); transform-origin: right center; }
          .book-front { position: relative; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1); border: 2px solid #475569; }
          .book-content { position: relative; width: 100%; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
          .cover-image { flex: 1; border-radius: 6px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
          .cover-overlay { text-align: center; background: rgba(0, 0, 0, 0.7); padding: 16px; border-radius: 6px; backdrop-filter: blur(10px); }
          .book-reader-container { display: flex; justify-content: center; align-items: flex-start; gap: 0; max-width: 100%; margin: 0 auto; perspective: 2000px; transition: transform 0.6s ease-in-out; padding: 20px 0; position: relative; }
          .book-reader-container.page-turning { transform: scale(0.98); }
          .book-page { position: relative; width: 500px; height: 650px; background: #f8fafc; border: 1px solid #e2e8f0; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8); transition: all 0.6s ease-in-out; }
          .left-page { border-radius: 12px 0 0 12px; border-right: none; transform-origin: right center; }
          .right-page { border-radius: 0 12px 12px 0; border-left: none; transform-origin: left center; }
          .book-binding { width: 25px; height: 650px; background: linear-gradient(to right, #1e293b, #334155, #1e293b); box-shadow: inset 3px 0 6px rgba(0, 0, 0, 0.3), inset -3px 0 6px rgba(0, 0, 0, 0.3); position: relative; }
          .book-binding::before { content: ''; position: absolute; top: 10%; left: 50%; transform: translateX(-50%); width: 3px; height: 80%; background: #475569; border-radius: 1px; }
          .page-content { position: relative; width: 100%; height: 100%; padding: 25px; display: flex; flex-direction: column; }
          .page-image { flex: 1; width: 100%; object-fit: contain; border-radius: 6px; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); }
          .page-number { position: absolute; bottom: 15px; font-size: 14px; color: #64748b; font-weight: 500; }
          .page-number.left { left: 25px; }
          .page-number.right { right: 25px; }
          .book-controls { display: flex; justify-content: space-between; align-items: center; margin: 30px auto; max-width: 700px; padding: 0 20px; }
          .control-btn { display: flex; align-items: center; gap: 10px; padding: 14px 20px; background: rgba(51, 65, 85, 0.8); color: white; border: 1px solid #475569; border-radius: 10px; font-weight: 500; font-size: 15px; transition: all 0.3s ease; backdrop-filter: blur(10px); }
          .control-btn:hover:not(:disabled) { background: rgba(245, 158, 11, 0.9); color: black; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3); }
          .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
          .page-indicator { padding: 10px 16px; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 20px; font-weight: 500; font-size: 15px; backdrop-filter: blur(10px); }
          .page-thumbnails { margin-top: 40px; padding: 20px; background: rgba(30, 41, 59, 0.5); border-radius: 12px; backdrop-filter: blur(10px); }
          .thumbnails-container { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: thin; scrollbar-color: #475569 transparent; }
          .thumbnail-btn { position: relative; flex-shrink: 0; width: 70px; height: 90px; border: 2px solid transparent; border-radius: 6px; overflow: hidden; transition: all 0.3s ease; background: white; }
          .thumbnail-btn:hover { border-color: #f59e0b; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
          .thumbnail-btn.active { border-color: #f59e0b; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); }
          .thumbnail-img { width: 100%; height: 100%; object-fit: cover; }
          .thumbnail-number { position: absolute; bottom: 2px; right: 4px; background: rgba(0, 0, 0, 0.7); color: white; font-size: 10px; padding: 2px 4px; border-radius: 2px; font-weight: 500; }
          
          /* Ensure modal doesn't interfere with page scroll when hidden */
          #pdf-modal.hidden {
            display: none !important;
            position: fixed !important;
          }
          
          /* Modal should allow internal scrolling when content is large */
          #pdf-modal {
            overflow-y: auto;
          }
          
          #pdf-modal .relative {
            max-height: 90vh;
            overflow-y: auto;
          }
          
          /* Ensure all containers allow normal document flow */
          .book-viewer-container {
            position: relative !important;
            overflow: visible !important;
            height: auto !important;
          }
          @media (max-width: 1200px) {
            .book-page { width: 450px; height: 600px; }
            .book-binding { height: 600px; width: 20px; }
            .page-content { padding: 20px; }
          }
          @media (max-width: 1024px) {
            .book-reader-container { flex-direction: column; gap: 20px; align-items: center; }
            .book-page { width: 400px; height: 550px; }
            .left-page, .right-page { border-radius: 12px; border: 1px solid #e2e8f0; }
            .book-binding { display: none; }
            .book-controls { flex-direction: column; gap: 16px; max-width: 100%; }
            .control-btn { width: 100%; justify-content: center; }
          }
          @media (max-width: 768px) {
            .book-page { width: 320px; height: 450px; }
            .page-content { padding: 15px; }
            .book-container { padding: 0 10px; }
            .book-reader-container { padding: 10px 0; }
          }
        `;
        document.head.appendChild(style);
      }
    }
    
    // Create simple PDF card element
    function createSimplePDFCard(pdf: any) {
      const sizeInMB = (pdf.size / (1024 * 1024)).toFixed(1);
      const currentLang = getPreferredLanguage();
      
      const container = document.createElement('div');
      container.className = 'bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-xl p-6';
      container.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="flex-shrink-0">
            <svg class="w-12 h-12 text-red-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
            </svg>
          </div>
          <div class="flex-grow">
            <h3 class="text-xl font-bold text-white mb-1">${pdf.filename}</h3>
            <p class="text-white/70 text-sm">PDF Document ‚Ä¢ ${sizeInMB} MB</p>
            <p class="text-white/60 text-xs mt-1">Click to download and view the complete process bundle</p>
          </div>
          <div class="flex-shrink-0">
            <a href="${pdf.url}" target="_blank" 
               class="px-6 py-3 bg-amber-500 text-black font-semibold rounded-lg hover:bg-amber-400 transition-colors">
              ${t('sections.downloadPdf', currentLang).replace('üì• ', '')}
            </a>
          </div>
        </div>
      `;
      
      return container;
    }
    
    // Fetch images from API
    async function loadImages() {
      console.log('Loading images...');
      try {
        const response = await fetch('/api/images/2');
        const data = await response.json();
        
        const loading = document.getElementById('loading');
        const grid = document.getElementById('images-grid');
        const noContent = document.getElementById('no-content');
        const error = document.getElementById('error');
        
        if (!response.ok) {
          throw new Error('Failed to fetch images');
        }
        
        if (loading) loading.classList.add('hidden');
        
        if (data.files && data.files.length > 0) {
          if (grid) {
            grid.classList.remove('hidden');
            
            data.files.forEach((file, index) => {
              const card = document.createElement('div');
              card.className = 'bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-xl p-6 hover:border-amber-400/50 transition-all duration-300';
              card.setAttribute('data-aos', 'fade-up');
              card.setAttribute('data-aos-delay', (index * 100).toString());
              
              card.innerHTML = `
                <div class="flex items-center justify-center h-48 bg-slate-700/50 rounded-lg mb-4 overflow-hidden">
                  <img 
                    src="${file.url}" 
                    alt="${file.filename}"
                    class="w-full h-full object-cover rounded-lg"
                    loading="lazy"
                  />
                </div>
                <h3 class="font-semibold text-white mb-2 truncate">${file.filename}</h3>
                <a 
                  href="${file.url}"
                  target="_blank"
                  class="text-amber-400 text-sm hover:text-amber-300 transition-colors view-full-size"
                >
                  View Full Size
                </a>
              `;
              
              grid.appendChild(card);
            });
          }
        } else {
          if (noContent) noContent.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Error loading images:', err);
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        if (loading) loading.classList.add('hidden');
        if (error) error.classList.remove('hidden');
      }
    }
    
    // Modal functionality for PDF pages
    function setupPDFModal() {
      // Create modal if it doesn't exist
      if (!document.getElementById('pdf-modal')) {
        const modal = document.createElement('div');
        modal.id = 'pdf-modal';
        modal.className = 'fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4';
        modal.innerHTML = `
          <div class="relative max-w-7xl max-h-full">
            <button id="close-pdf-modal" class="absolute -top-12 right-0 text-white hover:text-amber-400 transition-colors">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <img id="pdf-modal-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg" />
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
              <div class="bg-black/70 text-white px-4 py-2 rounded-full text-sm">
                <span id="pdf-modal-page-info"></span>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Setup modal event listeners
        const closeBtn = document.getElementById('close-pdf-modal');
        closeBtn?.addEventListener('click', () => {
          closeModal();
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
          }
        });
        
        function closeModal() {
          modal.classList.add('hidden');
          // Restore page scrolling when modal is closed
          document.body.style.overflow = 'auto';
          document.documentElement.style.overflow = 'auto';
        }
        
        function openModal() {
          modal.classList.remove('hidden');
          // Prevent background scrolling when modal is open
          document.body.style.overflow = 'hidden';
          document.documentElement.style.overflow = 'hidden';
        }
        
        // Store functions on modal for external access
        modal.closeModal = closeModal;
        modal.openModal = openModal;
      }
      
      // Setup click handlers for PDF page cards
      document.addEventListener('click', (e) => {
        const card = (e.target as Element).closest('.pdf-page-card');
        if (card) {
          const pageNumber = card.getAttribute('data-page');
          const fullImage = card.getAttribute('data-full-image');
          const modal = document.getElementById('pdf-modal') as any;
          const modalImage = document.getElementById('pdf-modal-image');
          const modalPageInfo = document.getElementById('pdf-modal-page-info');
          
          if (modalImage && modalPageInfo && modal) {
            (modalImage as HTMLImageElement).src = fullImage || '';
            (modalImage as HTMLImageElement).alt = `Page ${pageNumber}`;
            modalPageInfo.textContent = `Page ${pageNumber}`;
            
            // Use the modal's open function to properly handle scrolling
            if (modal.openModal) {
              modal.openModal();
            } else {
              modal.classList.remove('hidden');
              // Fallback: prevent background scrolling
              document.body.style.overflow = 'hidden';
              document.documentElement.style.overflow = 'hidden';
            }
          }
        }
      });
    }
    
      // Initialize everything
      updateTranslations();
      loadPDFs();
      setupPDFModal();
      
      // Setup book interactions
      setupBookInteractions();
      
      // Listen for language changes
      window.addEventListener('languagechange', updateTranslations);
    }
    
    // Setup book interactions
    function setupBookInteractions() {
      // Book viewer variables
      let currentSpread = 1;
      
      function getCurrentPDF() {
        const container = document.querySelector('.book-viewer-container');
        if (!container) return null;
        
        const totalPages = parseInt(container.getAttribute('data-total-pages') || '0');
        const pagesData = JSON.parse(container.getAttribute('data-pages') || '[]');
        
        return { totalPages, pages: pagesData };
      }
      
      function switchToBookView() {
        const bookView = document.getElementById('book-view');
        const gridView = document.getElementById('grid-view');
        const bookViewBtn = document.getElementById('book-view-btn');
        const gridViewBtn = document.getElementById('grid-view-btn');
        
        if (bookView && gridView) {
          bookView.classList.remove('hidden');
          gridView.classList.add('hidden');
        }
        
        if (bookViewBtn && gridViewBtn) {
          bookViewBtn.classList.add('bg-amber-500', 'text-black');
          bookViewBtn.classList.remove('bg-slate-700', 'text-white');
          gridViewBtn.classList.remove('bg-amber-500', 'text-black');
          gridViewBtn.classList.add('bg-slate-700', 'text-white');
        }
        
        // Ensure page can scroll in book view too
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
      }
      
      function switchToGridView() {
        const bookView = document.getElementById('book-view');
        const gridView = document.getElementById('grid-view');
        const bookViewBtn = document.getElementById('book-view-btn');
        const gridViewBtn = document.getElementById('grid-view-btn');
        
        if (bookView && gridView) {
          bookView.classList.add('hidden');
          gridView.classList.remove('hidden');
          // Ensure grid view is properly positioned for scrolling
          gridView.style.position = 'relative';
          gridView.style.overflow = 'visible';
          gridView.style.height = 'auto';
        }
        
        if (bookViewBtn && gridViewBtn) {
          gridViewBtn.classList.add('bg-amber-500', 'text-black');
          gridViewBtn.classList.remove('bg-slate-700', 'text-white');
          bookViewBtn.classList.remove('bg-amber-500', 'text-black');
          bookViewBtn.classList.add('bg-slate-700', 'text-white');
        }
        
        // Ensure page can scroll after switching to grid view
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
      }
      
      function updateBookPages() {
        const pdf = getCurrentPDF();
        if (!pdf) return;
        
        const leftPageImg = document.getElementById('left-page-img');
        const rightPageImg = document.getElementById('right-page-img');
        const leftPageNumber = document.getElementById('left-page-number');
        const rightPageNumber = document.getElementById('right-page-number');
        const currentSpreadSpan = document.getElementById('current-spread');
        const prevBtn = document.getElementById('prev-page-btn');
        const nextBtn = document.getElementById('next-page-btn');
        
        // Calculate page numbers for current spread
        const leftPageNum = (currentSpread - 1) * 2 + 1;
        const rightPageNum = leftPageNum + 1;
        
        // Update left page
        if (leftPageNum <= pdf.totalPages && pdf.pages[leftPageNum - 1]) {
          if (leftPageImg) (leftPageImg as HTMLImageElement).src = pdf.pages[leftPageNum - 1].imageUrl;
          if (leftPageNumber) leftPageNumber.textContent = leftPageNum.toString();
        } else {
          if (leftPageImg) (leftPageImg as HTMLImageElement).src = '';
          if (leftPageNumber) leftPageNumber.textContent = '';
        }
        
        // Update right page
        if (rightPageNum <= pdf.totalPages && pdf.pages[rightPageNum - 1]) {
          if (rightPageImg) (rightPageImg as HTMLImageElement).src = pdf.pages[rightPageNum - 1].imageUrl;
          if (rightPageNumber) rightPageNumber.textContent = rightPageNum.toString();
        } else {
          if (rightPageImg) (rightPageImg as HTMLImageElement).src = '';
          if (rightPageNumber) rightPageNumber.textContent = '';
        }
        
        // Update spread indicator
        if (currentSpreadSpan) {
          if (rightPageNum <= pdf.totalPages) {
            currentSpreadSpan.textContent = `${leftPageNum}-${rightPageNum}`;
          } else {
            currentSpreadSpan.textContent = leftPageNum.toString();
          }
        }
        
        // Update button states
        const totalSpreads = Math.ceil(pdf.totalPages / 2);
        if (prevBtn) (prevBtn as HTMLButtonElement).disabled = currentSpread === 1;
        if (nextBtn) (nextBtn as HTMLButtonElement).disabled = currentSpread === totalSpreads;
        
        // Update thumbnail highlights
        document.querySelectorAll('.thumbnail-btn').forEach((thumb, index) => {
          const pageNum = index + 1;
          if (pageNum === leftPageNum || pageNum === rightPageNum) {
            thumb.classList.add('active');
          } else {
            thumb.classList.remove('active');
          }
        });
        
        // Add page turn animation
        const bookReader = document.querySelector('.book-reader-container');
        if (bookReader) {
          bookReader.classList.add('page-turning');
          setTimeout(() => {
            bookReader.classList.remove('page-turning');
          }, 600);
        }
      }
      
      // Event delegation for all interactions
      document.addEventListener('click', (e) => {
        const target = e.target as Element;
        
        // Handle book viewer interactions
        if (target.id === 'open-book-btn' || target.closest('#open-book-btn')) {
          const bookCover = document.querySelector('.book-cover');
          const bookReader = document.getElementById('book-reader');
          
          if (bookCover && bookReader) {
            (bookCover as HTMLElement).style.transform = 'rotateY(-180deg)';
            setTimeout(() => {
              bookCover.classList.add('hidden');
              bookReader.classList.remove('hidden');
              updateBookPages();
            }, 600);
          }
          return;
        }
        
        // Handle view switching
        if (target.id === 'book-view-btn' || target.closest('#book-view-btn')) {
          switchToBookView();
          return;
        }
        
        if (target.id === 'grid-view-btn' || target.closest('#grid-view-btn')) {
          switchToGridView();
          return;
        }
        
        // Handle book navigation
        if (target.id === 'prev-page-btn' || target.closest('#prev-page-btn')) {
          if (currentSpread > 1) {
            currentSpread--;
            updateBookPages();
          }
          return;
        }
        
        if (target.id === 'next-page-btn' || target.closest('#next-page-btn')) {
          const pdf = getCurrentPDF();
          const totalSpreads = Math.ceil(pdf?.totalPages / 2 || 1);
          if (currentSpread < totalSpreads) {
            currentSpread++;
            updateBookPages();
          }
          return;
        }
        
        // Handle thumbnail navigation
        const thumbnailBtn = target.closest('.thumbnail-btn');
        if (thumbnailBtn) {
          const pageNum = parseInt(thumbnailBtn.getAttribute('data-page') || '1');
          currentSpread = Math.ceil(pageNum / 2);
          updateBookPages();
          return;
        }
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        const bookReader = document.getElementById('book-reader');
        
        if (bookReader && !bookReader.classList.contains('hidden')) {
          const pdf = getCurrentPDF();
          const totalSpreads = Math.ceil(pdf?.totalPages / 2 || 1);
          
          if (e.key === 'ArrowLeft' && currentSpread > 1) {
            currentSpread--;
            updateBookPages();
          } else if (e.key === 'ArrowRight' && currentSpread < totalSpreads) {
            currentSpread++;
            updateBookPages();
          }
        }
      });
      
      // Initialize book view after a short delay to ensure DOM is ready
      setTimeout(() => {
        switchToBookView();
      }, 500);
    }
  </script>
  
  <!-- Navigation to other sections -->
  <section class="py-12 px-6 border-t border-white/10">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <a href="/section-1" class="text-white/70 hover:text-amber-400 transition-colors">
        ‚Üê <span data-i18n="nav.section1">Nodes</span>
      </a>
      <a href="/section-3" class="text-white/70 hover:text-amber-400 transition-colors">
        <span data-i18n="nav.section3">Photo Map</span> ‚Üí
      </a>
    </div>
  </section>

  <!-- Add some extra content to ensure scrolling works -->
  <section class="py-24 px-6 bg-slate-900/50">
    <div class="max-w-7xl mx-auto text-center">
      <h3 class="text-2xl font-bold mb-8 text-white" data-i18n="sections.aboutProcessBundle">About This Process Bundle</h3>
      <div class="grid md:grid-cols-2 gap-8 text-left">
        <div class="bg-slate-800/30 p-6 rounded-xl">
          <h4 class="text-xl font-semibold mb-4 text-amber-400" data-i18n="sections.designDevelopment">Design Development</h4>
          <p class="text-white/70 leading-relaxed" data-i18n="sections.designDevelopmentDescription">
            This comprehensive process bundle documents our complete design journey from initial concept sketches to final architectural presentation. Each page represents a crucial step in our design methodology.
          </p>
        </div>
        <div class="bg-slate-800/30 p-6 rounded-xl">
          <h4 class="text-xl font-semibold mb-4 text-amber-400" data-i18n="sections.documentationProcess">Documentation Process</h4>
          <p class="text-white/70 leading-relaxed" data-i18n="sections.documentationProcessDescription">
            The documentation includes technical drawings, conceptual diagrams, material studies, and presentation layouts that showcase our architectural thinking and design evolution.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Additional spacing for scroll testing -->
  <div class="h-96"></div>
</BaseLayout>
