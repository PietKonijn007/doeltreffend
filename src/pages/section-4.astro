---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Hero from '../components/Hero.astro';

// Images will be loaded client-side from S3 via API
---

<BaseLayout title="Foto's - Doeltreffend">
  <Navigation />
  
  <!-- Hero Section -->
  <Hero 
    title="Photos"
    subtitle="Photos"
    height="large"
  />
  
  <!-- Content Section -->
  <section class="py-24 px-6 max-w-7xl mx-auto">
    <div class="mb-16" data-aos="fade-up">
      <h2 class="text-3xl md:text-4xl font-bold mb-4" data-i18n="sections.overview">Overview</h2>
      <p class="text-white/70 text-lg max-w-3xl" data-i18n="sections.section4Description">
        View our photo collection.
      </p>
    </div>
    
    <!-- Loading state -->
    <div id="loading" class="text-center py-20">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-400"></div>
      <p class="mt-4 text-white/70" data-i18n="sections.loading">Loading images...</p>
    </div>

    <!-- Masonry Grid Container -->
    <div id="images-grid" class="hidden masonry-grid"></div>

    <!-- No content placeholder -->
    <div id="no-content" class="hidden text-center py-20" data-aos="fade-up">
      <div class="mb-8">
        <svg class="w-24 h-24 mx-auto text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold mb-4" data-i18n="sections.noContent">No Content Yet</h3>
      <p class="text-white/60 max-w-md mx-auto" data-i18n="sections.noContentDescription">
        Images will appear here once uploaded to S3.
      </p>
    </div>

    <!-- Error state -->
    <div id="error" class="hidden text-center py-20 text-red-400">
      <p data-i18n="sections.errorLoading">Failed to load images. Please try again later.</p>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm">
    <button id="lightbox-close" class="absolute top-6 right-6 text-white/80 hover:text-white z-50">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    
    <button id="lightbox-prev" class="absolute left-6 top-1/2 -translate-y-1/2 text-white/80 hover:text-white z-50">
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    
    <button id="lightbox-next" class="absolute right-6 top-1/2 -translate-y-1/2 text-white/80 hover:text-white z-50">
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
    
    <div class="flex items-center justify-center w-full h-full p-6">
      <img id="lightbox-img" src="" alt="" class="max-w-full max-h-full object-contain" />
    </div>
    
    <div class="absolute bottom-6 left-0 right-0 text-center text-white/80">
      <p id="lightbox-caption" class="text-sm"></p>
      <p id="lightbox-counter" class="text-xs mt-2"></p>
    </div>
  </div>

  <style>
    .masonry-grid {
      column-count: 1;
      column-gap: 1rem;
    }

    @media (min-width: 640px) {
      .masonry-grid {
        column-count: 2;
      }
    }

    @media (min-width: 1024px) {
      .masonry-grid {
        column-count: 3;
      }
    }

    @media (min-width: 1280px) {
      .masonry-grid {
        column-count: 4;
      }
    }

    .masonry-item {
      break-inside: avoid;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .masonry-item:hover {
      transform: translateY(-4px);
    }

    .masonry-item img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 0.5rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: border-color 0.3s ease;
    }

    .masonry-item:hover img {
      border-color: rgba(251, 191, 36, 0.5);
    }

    #lightbox {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #lightbox-img {
      animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>

  <script>
    import { getPreferredLanguage, t } from '../i18n/utils';
    
    let allImages: Array<{url: string, filename: string}> = [];
    let currentImageIndex = 0;
    
    // Update translations
    function updateTranslations() {
      const currentLang = getPreferredLanguage();
      
      // Update text content
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = (el as HTMLElement).dataset.i18n;
        if (key) {
          el.textContent = t(key, currentLang);
        }
      });
      
      // Update Hero title and subtitle
      const heroTitle = document.querySelector('.hero-section h1');
      const heroSubtitle = document.querySelector('.hero-section p');
      if (heroTitle) heroTitle.textContent = t('sections.section4Title', currentLang);
      if (heroSubtitle) heroSubtitle.textContent = t('sections.section4Subtitle', currentLang);
    }
    
    // Lightbox functions
    function openLightbox(index: number) {
      currentImageIndex = index;
      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightbox-img') as HTMLImageElement;
      const caption = document.getElementById('lightbox-caption');
      const counter = document.getElementById('lightbox-counter');
      
      if (lightbox && img && caption && counter) {
        img.src = allImages[index].url;
        img.alt = allImages[index].filename;
        caption.textContent = allImages[index].filename;
        counter.textContent = `${index + 1} / ${allImages.length}`;
        lightbox.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      if (lightbox) {
        lightbox.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }
    
    function showNextImage() {
      currentImageIndex = (currentImageIndex + 1) % allImages.length;
      openLightbox(currentImageIndex);
    }
    
    function showPrevImage() {
      currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
      openLightbox(currentImageIndex);
    }
    
    // Fetch images from API and create masonry layout
    async function loadImages() {
      try {
        const response = await fetch('/api/images/4');
        const data = await response.json();
        
        const loading = document.getElementById('loading');
        const grid = document.getElementById('images-grid');
        const noContent = document.getElementById('no-content');
        const error = document.getElementById('error');
        
        if (!response.ok) {
          throw new Error('Failed to fetch images');
        }
        
        if (loading) loading.classList.add('hidden');
        
        if (data.files && data.files.length > 0) {
          allImages = data.files;
          
          if (grid) {
            grid.classList.remove('hidden');
            
            data.files.forEach((file: any, index: number) => {
              const item = document.createElement('div');
              item.className = 'masonry-item';
              item.setAttribute('data-index', index.toString());
              
              const img = document.createElement('img');
              img.src = file.url;
              img.alt = file.filename;
              img.loading = 'lazy';
              
              item.appendChild(img);
              
              // Click to open lightbox
              item.addEventListener('click', () => {
                openLightbox(index);
              });
              
              grid.appendChild(item);
            });
          }
        } else {
          if (noContent) noContent.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Error loading images:', err);
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        if (loading) loading.classList.add('hidden');
        if (error) error.classList.remove('hidden');
      }
    }
    
    // Initialize
    updateTranslations();
    loadImages();
    
    // Lightbox event listeners
    document.getElementById('lightbox-close')?.addEventListener('click', closeLightbox);
    document.getElementById('lightbox-next')?.addEventListener('click', showNextImage);
    document.getElementById('lightbox-prev')?.addEventListener('click', showPrevImage);
    
    // Close lightbox on background click
    document.getElementById('lightbox')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeLightbox();
      }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      const lightbox = document.getElementById('lightbox');
      if (lightbox && !lightbox.classList.contains('hidden')) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') showNextImage();
        if (e.key === 'ArrowLeft') showPrevImage();
      }
    });
    
    // Listen for language changes
    window.addEventListener('languagechange', updateTranslations);
  </script>
  
  <!-- Navigation to other sections -->
  <section class="py-12 px-6 border-t border-white/10">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <a href="/section-3" class="text-white/70 hover:text-amber-400 transition-colors">
        ← <span data-i18n="nav.section3">Photo Map</span>
      </a>
      <a href="/" class="text-white/70 hover:text-amber-400 transition-colors" data-i18n="sections.backToHome">
        Back to Home →
      </a>
    </div>
  </section>
</BaseLayout>
