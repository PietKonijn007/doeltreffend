---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Hero from '../components/Hero.astro';

// 9 nodes with their details
const nodes = [
  { id: 1, key: 'node1' },
  { id: 2, key: 'node2' },
  { id: 3, key: 'node3' },
  { id: 4, key: 'node4' },
  { id: 5, key: 'node5' },
  { id: 6, key: 'node6' },
  { id: 7, key: 'node7' },
  { id: 8, key: 'node8' },
  { id: 9, key: 'node9' },
];
---

<BaseLayout title="Knopen - Doel - Scharnierpunt">
  <Navigation />
  
  <!-- Hero Section -->
  <Hero 
    title="Nodes"
    subtitle="Nodes for structural analysis and strength"
    height="large"
  />
  
  <!-- Nodes Grid Section -->
  <section class="py-24 px-6 max-w-7xl mx-auto bg-stone-100 rounded-3xl">
    <div class="mb-16 text-center" data-aos="fade-up">
      <h2 class="text-3xl md:text-4xl font-bold mb-2 text-stone-800 uppercase tracking-wider">Structural Details</h2>
    </div>
    
    <!-- Loading state -->
    <div id="loading" class="text-center py-20">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-400"></div>
      <p class="mt-4 text-white/70" data-i18n="sections.loading">Loading images...</p>
    </div>

    <!-- Nodes Grid -->
    <div id="nodes-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {nodes.map((node, index) => (
        <div 
          class="node-card group cursor-pointer" 
          data-node-id={node.id}
          data-aos="fade-up" 
          data-aos-delay={index * 100}
        >
          <div class="relative overflow-hidden rounded-lg bg-white shadow-md hover:shadow-xl transition-all duration-300">
            <!-- Image container - full image, no crop -->
            <div class="relative overflow-hidden p-4 bg-white">
              <img 
                data-thumb-src=""
                alt="Node"
                class="node-thumb w-full h-auto object-contain"
                loading="lazy"
              />
            </div>
            
            <!-- Title below image -->
            <div class="px-4 pb-4 pt-2 bg-white border-t border-stone-200">
              <h3 
                class="node-title text-base font-semibold text-stone-800 text-center"
                data-i18n={`sections.${node.key}`}
              >
                Loading...
              </h3>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Error state -->
    <div id="error" class="hidden text-center py-20 text-red-400">
      <p data-i18n="sections.errorLoading">Failed to load images.</p>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4 md:p-8">
    <button 
      id="close-lightbox" 
      class="absolute top-4 right-4 md:top-8 md:right-8 text-white/70 hover:text-white z-50 transition-colors"
      aria-label="Close"
    >
      <svg class="w-8 h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    
    <!-- Zoom Controls -->
    <div class="absolute top-4 left-4 md:top-8 md:left-8 flex flex-col gap-2 z-50">
      <button 
        id="zoom-in" 
        class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-lg transition-colors"
        aria-label="Zoom In"
        title="Zoom In (Scroll up)"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"/>
        </svg>
      </button>
      <button 
        id="zoom-out" 
        class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-lg transition-colors"
        aria-label="Zoom Out"
        title="Zoom Out (Scroll down)"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
        </svg>
      </button>
      <button 
        id="zoom-reset" 
        class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-lg transition-colors"
        aria-label="Reset Zoom"
        title="Reset (Double-click image)"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
      </button>
    </div>
    
    <div class="max-w-6xl w-full">
      <!-- Title -->
      <div class="mb-6 text-center">
        <h2 id="lightbox-title" class="text-2xl md:text-4xl font-serif font-bold text-white tracking-wide"></h2>
      </div>
      
      <!-- Detail Image Container with Pan/Zoom -->
      <div id="image-container" class="relative overflow-hidden rounded-lg cursor-grab active:cursor-grabbing flex items-center justify-center" style="max-height: 70vh; max-width: 90vw;">
        <img 
          id="lightbox-image" 
          src="" 
          alt="" 
          class="max-w-full max-h-[70vh] w-auto h-auto object-contain transition-transform duration-200 select-none"
          draggable="false"
        />
      </div>
      
      <!-- Navigation arrows -->
      <button 
        id="prev-node" 
        class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition-colors"
        aria-label="Previous"
      >
        <svg class="w-10 h-10 md:w-12 md:h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      
      <button 
        id="next-node" 
        class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition-colors"
        aria-label="Next"
      >
        <svg class="w-10 h-10 md:w-12 md:h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    import { getPreferredLanguage, t } from '../i18n/utils';
    
    let currentNodeId = 1;
    const totalNodes = 9;
    let nodeImages: Record<number, { thumb: string; detail: string; }> = {};
    
    // Update translations
    function updateTranslations() {
      const currentLang = getPreferredLanguage();
      
      // Update all text with data-i18n
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = (el as HTMLElement).dataset.i18n;
        if (key) {
          el.textContent = t(key, currentLang);
        }
      });
      
      // Update Hero
      const heroTitle = document.querySelector('.hero-section h1');
      const heroSubtitle = document.querySelector('.hero-section p');
      if (heroTitle) heroTitle.textContent = t('sections.section1Title', currentLang);
      if (heroSubtitle) heroSubtitle.textContent = t('sections.section1Subtitle', currentLang);
      
      // Update lightbox title if open
      const lightbox = document.getElementById('lightbox');
      if (lightbox && !lightbox.classList.contains('hidden')) {
        updateLightboxTitle(currentNodeId);
      }
    }
    
    // Fetch node images from S3
    async function loadNodeImages() {
      try {
        const response = await fetch('/api/images/1');
        if (!response.ok) throw new Error('Failed to fetch images');
        
        const data = await response.json();
        
        // Organize images by node ID
        if (data.files && data.files.length > 0) {
          data.files.forEach((file: any) => {
            const match = file.filename.match(/^(\d+)_(thumb|detail)\.jpg$/);
            if (match) {
              const nodeId = parseInt(match[1]);
              const type = match[2];
              
              if (!nodeImages[nodeId]) {
                nodeImages[nodeId] = { thumb: '', detail: '' };
              }
              
              if (type === 'thumb') {
                nodeImages[nodeId].thumb = file.url;
              } else {
                nodeImages[nodeId].detail = file.url;
              }
            }
          });
          
          // Display thumbnails
          displayNodes();
        } else {
          showError();
        }
      } catch (err) {
        console.error('Error loading node images:', err);
        showError();
      }
    }
    
    // Display node thumbnails
    function displayNodes() {
      const loading = document.getElementById('loading');
      const grid = document.getElementById('nodes-grid');
      
      if (loading) loading.classList.add('hidden');
      if (grid) grid.classList.remove('hidden');
      
      // Set thumbnail images
      for (let i = 1; i <= totalNodes; i++) {
        const card = document.querySelector(`[data-node-id="${i}"]`);
        if (card && nodeImages[i]) {
          const img = card.querySelector('.node-thumb') as HTMLImageElement;
          if (img) {
            img.src = nodeImages[i].thumb;
            img.alt = t(`sections.node${i}`, getPreferredLanguage());
          }
        }
      }
      
      // Add click handlers
      document.querySelectorAll('.node-card').forEach(card => {
        card.addEventListener('click', () => {
          const nodeId = parseInt((card as HTMLElement).dataset.nodeId || '1');
          openLightbox(nodeId);
        });
      });
    }
    
    // Open lightbox with detail image
    function openLightbox(nodeId: number) {
      currentNodeId = nodeId;
      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
      
      if (lightbox && lightboxImage && nodeImages[nodeId]) {
        lightboxImage.src = nodeImages[nodeId].detail;
        updateLightboxTitle(nodeId);
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }
    }
    
    // Close lightbox
    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      if (lightbox) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
        document.body.style.overflow = '';
      }
    }
    
    // Update lightbox title
    function updateLightboxTitle(nodeId: number) {
      const title = document.getElementById('lightbox-title');
      if (title) {
        title.textContent = t(`sections.node${nodeId}`, getPreferredLanguage());
      }
    }
    
    // Navigate to previous node
    function prevNode() {
      currentNodeId = currentNodeId > 1 ? currentNodeId - 1 : totalNodes;
      openLightbox(currentNodeId);
    }
    
    // Navigate to next node
    function nextNode() {
      currentNodeId = currentNodeId < totalNodes ? currentNodeId + 1 : 1;
      openLightbox(currentNodeId);
    }
    
    // Show error
    function showError() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      if (loading) loading.classList.add('hidden');
      if (error) error.classList.remove('hidden');
    }
    
    // Zoom and Pan functionality
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    
    function resetZoom() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateImageTransform();
    }
    
    function zoomIn() {
      scale = Math.min(scale * 1.3, 5); // Max 5x zoom
      updateImageTransform();
    }
    
    function zoomOut() {
      scale = Math.max(scale / 1.3, 1); // Min 1x zoom
      if (scale === 1) {
        translateX = 0;
        translateY = 0;
      }
      updateImageTransform();
    }
    
    function updateImageTransform() {
      const img = document.getElementById('lightbox-image') as HTMLImageElement;
      if (img) {
        img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
      }
    }
    
    // Mouse/Touch drag to pan
    const imageContainer = document.getElementById('image-container');
    const lightboxImage = document.getElementById('lightbox-image');
    
    if (imageContainer && lightboxImage) {
      // Mouse events
      lightboxImage.addEventListener('mousedown', (e) => {
        if (scale > 1) {
          isDragging = true;
          startX = e.clientX - translateX;
          startY = e.clientY - translateY;
          imageContainer.style.cursor = 'grabbing';
        }
      });
      
      document.addEventListener('mousemove', (e) => {
        if (isDragging && scale > 1) {
          translateX = e.clientX - startX;
          translateY = e.clientY - startY;
          updateImageTransform();
        }
      });
      
      document.addEventListener('mouseup', () => {
        isDragging = false;
        if (imageContainer) imageContainer.style.cursor = 'grab';
      });
      
      // Mouse wheel zoom
      imageContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        if (e.deltaY < 0) {
          zoomIn();
        } else {
          zoomOut();
        }
      });
      
      // Double-click to reset
      lightboxImage.addEventListener('dblclick', resetZoom);
      
      // Touch events for mobile
      let touchStartDistance = 0;
      let initialScale = 1;
      
      lightboxImage.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          touchStartDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          initialScale = scale;
        } else if (e.touches.length === 1 && scale > 1) {
          isDragging = true;
          startX = e.touches[0].clientX - translateX;
          startY = e.touches[0].clientY - translateY;
        }
      });
      
      lightboxImage.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          scale = Math.max(1, Math.min(5, initialScale * (currentDistance / touchStartDistance)));
          updateImageTransform();
        } else if (e.touches.length === 1 && isDragging && scale > 1) {
          translateX = e.touches[0].clientX - startX;
          translateY = e.touches[0].clientY - startY;
          updateImageTransform();
        }
      });
      
      lightboxImage.addEventListener('touchend', () => {
        isDragging = false;
        if (scale === 1) {
          translateX = 0;
          translateY = 0;
          updateImageTransform();
        }
      });
    }
    
    // Zoom button event listeners
    document.getElementById('zoom-in')?.addEventListener('click', zoomIn);
    document.getElementById('zoom-out')?.addEventListener('click', zoomOut);
    document.getElementById('zoom-reset')?.addEventListener('click', resetZoom);
    
    // Event listeners
    document.getElementById('close-lightbox')?.addEventListener('click', () => {
      resetZoom();
      closeLightbox();
    });
    document.getElementById('prev-node')?.addEventListener('click', () => {
      resetZoom();
      prevNode();
    });
    document.getElementById('next-node')?.addEventListener('click', () => {
      resetZoom();
      nextNode();
    });
    
    // Close lightbox on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        resetZoom();
        closeLightbox();
      }
      if (e.key === 'ArrowLeft') {
        resetZoom();
        prevNode();
      }
      if (e.key === 'ArrowRight') {
        resetZoom();
        nextNode();
      }
    });
    
    // Close lightbox on background click
    document.getElementById('lightbox')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        resetZoom();
        closeLightbox();
      }
    });
    
    // Initialize
    updateTranslations();
    window.addEventListener('languagechange', updateTranslations);
    loadNodeImages();
  </script>
  
  <!-- Navigation to other sections -->
  <section class="py-12 px-6 border-t border-white/10">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <a href="/" class="text-white/70 hover:text-amber-400 transition-colors" data-i18n="sections.backToHome">
        ← Back to Home
      </a>
      <a href="/section-2" class="text-white/70 hover:text-amber-400 transition-colors">
        <span data-i18n="nav.section2">Section 2</span> →
      </a>
    </div>
  </section>
</BaseLayout>
